#!/bin/bash

echo "=== مدیریت پنل مانیتورینگ Netdata روی اوبونتو 22.04 ==="
echo "1) نصب پنل (پورت پیش‌فرض 19999، بدون احراز هویت)"
echo "2) فعال‌سازی احراز هویت و تغییر پورت"
echo "3) حذف کامل پنل"
read -p "لطفاً گزینه مورد نظر را وارد کنید (1 یا 2 یا 3): " CHOICE

NETDATA_CONF="/etc/netdata/netdata.conf"
HTPASSWD_FILE="/etc/netdata/htpasswd"

function install_netdata() {
    echo "در حال به‌روزرسانی سیستم..."
    apt update && apt upgrade -y

    echo "در حال نصب پیش‌نیازها..."
    apt install -y curl apache2-utils

    echo "اگر قبلاً نصب بود، پاک می‌کنیم..."
    systemctl stop netdata 2>/dev/null
    systemctl disable netdata 2>/dev/null
    apt remove --purge -y netdata
    rm -rf /etc/netdata

    echo "در حال نصب Netdata..."
    bash <(curl -Ss https://my-netdata.io/kickstart.sh) --dont-wait --disable-telemetry

    echo "راه‌اندازی مجدد Netdata..."
    systemctl restart netdata

    echo "✅ نصب با موفقیت انجام شد."
    echo "برای مشاهده پنل، مرورگر را باز کرده و آدرس زیر را وارد کنید:"
    echo "http://IP-Server:19999"
}

function enable_auth_and_port() {
    if [ ! -f "$NETDATA_CONF" ]; then
        echo "❌ فایل کانفیگ Netdata پیدا نشد. ابتدا باید نصب شود."
        exit 1
    fi

    read -p "یوزرنیم احراز هویت: " PANEL_USER
    read -sp "پسورد احراز هویت: " PANEL_PASS
    echo
    read -p "پورت جدید Netdata (مثلاً 19999): " PANEL_PORT

    # اضافه یا ویرایش بخش [web]
    if grep -q "^\[web\]" "$NETDATA_CONF"; then
        sed -i "/^\[web\]/,/^\[/ s/^bind port = .*/bind port = $PANEL_PORT/" "$NETDATA_CONF" || \
        sed -i "/^\[web\]/a bind port = $PANEL_PORT" "$NETDATA_CONF"
        if ! grep -q "basic auth login file" "$NETDATA_CONF"; then
            sed -i "/^\[web\]/a basic auth login file = $HTPASSWD_FILE" "$NETDATA_CONF"
        else
            sed -i "s|basic auth login file = .*|basic auth login file = $HTPASSWD_FILE|" "$NETDATA_CONF"
        fi
    else
        cat <<EOF >> "$NETDATA_CONF"

[web]
  bind port = $PANEL_PORT
  basic auth login file = $HTPASSWD_FILE
EOF
    fi

    echo "در حال ایجاد فایل htpasswd..."
    htpasswd -cb "$HTPASSWD_FILE" "$PANEL_USER" "$PANEL_PASS"
    chmod 640 "$HTPASSWD_FILE"
    chown netdata:netdata "$HTPASSWD_FILE"

    echo "راه‌اندازی مجدد Netdata..."
    systemctl restart netdata

    echo "✅ احراز هویت فعال شد و پورت به $PANEL_PORT تغییر یافت."
    echo "برای ورود به پنل، آدرس زیر را در مرورگر باز کنید:"
    echo "http://IP-Server:$PANEL_PORT"
}

function uninstall_netdata() {
    echo "⚠ در حال حذف کامل پنل Netdata..."
    systemctl stop netdata
    apt remove --purge -y netdata
    apt autoremove -y
    rm -rf /etc/netdata
    rm -f "$HTPASSWD_FILE"
    echo "✅ پنل و تمام فایل‌ها حذف شدند."
}

case "$CHOICE" in
    1)
        install_netdata
        ;;
    2)
        enable_auth_and_port
        ;;
    3)
        uninstall_netdata
        ;;
    *)
        echo "❌ گزینه نامعتبر!"
        ;;
esac
