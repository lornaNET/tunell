#!/bin/bash
set -e
echo "=== Ù†ØµØ¨ Ù¾Ù†Ù„ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ù„ÙˆØ±Ù†Ø§ (Ubuntu 22.04+) ==="
echo "1) Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"
echo "2) Ø­Ø°Ù Ú©Ø§Ù…Ù„"
read -p "Ø§Ù†ØªØ®Ø§Ø¨: " CHOICE

APP_DIR="/opt/lorna"
VENV_DIR="$APP_DIR/venv"
APP_PORT=5000
LICENSE_FILE="$APP_DIR/license.key"
LICENSE_VALUE="lorna"
SERVICE_NAME="lorna-monitor"
SYSTEMD_FILE="/etc/systemd/system/$SERVICE_NAME.service"
GUNICORN_WORKERS=3
XRAY_PORT=""
LOG_DIR="/var/log/lorna"
DEFAULT_USERNAME="admin"
DEFAULT_PASSWORD="admin123"

generate_secret_key(){ openssl rand -hex 16; }
check_port(){ ss -tuln | grep -q ":$1 " && return 1 || return 0; }
prompt_for_port(){ while true; do read -p "Ù¾ÙˆØ±Øª Ù¾Ù†Ù„ [${APP_PORT}]: " p; APP_PORT=${p:-$APP_PORT}; [[ ! $APP_PORT =~ ^[0-9]+$ ]] && echo "Ù†Ø§Ù…Ø¹ØªØ¨Ø±!" && continue; check_port $APP_PORT && break || echo "Ù¾ÙˆØ±Øª Ù…Ø´ØºÙˆÙ„ Ø§Ø³Øª."; done; }
prompt_for_xray_port(){ while true; do read -p "Ù¾ÙˆØ±Øª Xray (Ø®Ø§Ù„ÛŒ=ØºÛŒØ±ÙØ¹Ø§Ù„): " XRAY_PORT; [[ -z "$XRAY_PORT" ]] && break; [[ ! $XRAY_PORT =~ ^[0-9]+$ ]] && echo "Ù†Ø§Ù…Ø¹ØªØ¨Ø±!" && continue; break; done; }

if [ "$CHOICE" == "1" ]; then
  echo "[*] Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ..."
  systemctl stop "$SERVICE_NAME" 2>/dev/null || true
  systemctl disable "$SERVICE_NAME" 2>/dev/null || true
  rm -f "$SYSTEMD_FILE"
  pkill -f "gunicorn.*app:app" 2>/dev/null || true
  rm -rf "$APP_DIR" "$LOG_DIR"
  systemctl daemon-reload

  echo "[*] Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§..."
  apt update && apt install -y python3 python3-venv python3-pip iproute2 gunicorn curl

  prompt_for_port
  prompt_for_xray_port

  echo "[*] Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§..."
  mkdir -p "$APP_DIR" "$LOG_DIR"
  echo "$LICENSE_VALUE" > "$LICENSE_FILE"
  chmod 600 "$LICENSE_FILE"

  echo "[*] Ø³Ø§Ø®Øª Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ..."
  python3 -m venv "$VENV_DIR"
  source "$VENV_DIR/bin/activate"
  pip install --upgrade pip
  pip install flask==2.3.3 psutil==5.9.5 gunicorn==21.2.0

  SECRET_KEY=$(generate_secret_key)

cat > "$APP_DIR/app.py" <<PYEOF
from flask import Flask, render_template_string, request, redirect, url_for, session, jsonify
import psutil, os, time, threading, subprocess, logging
from logging.handlers import RotatingFileHandler

app = Flask(__name__)
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'key')

USERNAME = os.environ.get('LORNA_USERNAME', 'admin')
PASSWORD = os.environ.get('LORNA_PASSWORD', 'admin123')
LICENSE_FILE = "/opt/lorna/license.key"
LOG_DIR = "/var/log/lorna"
XRAY_PORT = os.environ.get('XRAY_PORT', '')

os.makedirs(LOG_DIR, exist_ok=True)
handler = RotatingFileHandler(f"{LOG_DIR}/lorna.log", maxBytes=10*1024*1024, backupCount=5)
handler.setFormatter(logging.Formatter('%(asctime)s - %(levelname)s - %(message)s'))
app.logger.addHandler(handler)
app.logger.setLevel(logging.INFO)

prev_net = {'bytes_sent': None, 'bytes_recv': None, 'time': None}
net_lock = threading.Lock()

def verify_license(k):
    return os.path.exists(LICENSE_FILE) and open(LICENSE_FILE).read().strip() == k.strip()

def net_speed():
    with net_lock:
        c = psutil.net_io_counters()
        now = time.time()
        if prev_net['time'] is None:
            prev_net.update({'bytes_sent': c.bytes_sent, 'bytes_recv': c.bytes_recv, 'time': now})
            return 0, 0
        dt = now - prev_net['time']
        ds = c.bytes_sent - prev_net['bytes_sent']
        dr = c.bytes_recv - prev_net['bytes_recv']
        prev_net.update({'bytes_sent': c.bytes_sent, 'bytes_recv': c.bytes_recv, 'time': now})
        return round((ds * 8) / (dt * 1e6), 3), round((dr * 8) / (dt * 1e6), 3)

def xray_users():
    if not XRAY_PORT:
        return 0, "ØºÛŒØ±ÙØ¹Ø§Ù„"
    try:
        cmd = ['ss', '-tn', f'sport = :{XRAY_PORT}']
        res = subprocess.run(cmd, capture_output=True, text=True)
        cnt = len([l for l in res.stdout.splitlines() if f":{XRAY_PORT}" in l and 'ESTAB' in l])
        return cnt, "ÙØ¹Ø§Ù„"
    except:
        return 0, "Ø®Ø·Ø§"

login_tpl = "<html><body><form method=post>{% if error %}<p>{{error}}</p>{% endif %}<input name=username><input name=password type=password><input name=license><button>ÙˆØ±ÙˆØ¯</button></form></body></html>"
dash_tpl = "<html><body>{% if not license_ok %}<form method=post action='{{url_for('set_license')}}'><input name=license><button>Ø«Ø¨Øª Ù„Ø§ÛŒØ³Ù†Ø³</button></form>{% endif %}<p>CPU: {{cpu}}%</p><p>RAM: {{ram}}%</p><p>Up: {{net.upload_mbps}} Mbps</p><p>Down: {{net.download_mbps}} Mbps</p><p>Xray: {{xray_status}}</p><a href='{{url_for('logout')}}'>Ø®Ø±ÙˆØ¬</a></body></html>"

@app.route('/', methods=['GET', 'POST'])
def login():
    if 'logged_in' in session:
        return redirect(url_for('dashboard'))
    error = None
    if request.method == 'POST':
        if request.form['username'] == USERNAME and request.form['password'] == PASSWORD:
            session['logged_in'] = True
            session['license_ok'] = verify_license(request.form['license'])
            return redirect(url_for('dashboard'))
        else:
            error = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡"
    return render_template_string(login_tpl, error=error)

@app.route('/dashboard')
@app.route('/dash')
def dashboard():
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    cpu = psutil.cpu_percent(0.1)
    ram = psutil.virtual_memory().percent
    up, down = net_speed()
    xu, xs = xray_users()
    return render_template_string(dash_tpl, cpu=cpu, ram=ram, net={'upload_mbps': up, 'download_mbps': down}, license_ok=session.get('license_ok', False), xray_status=xs)

@app.route('/set_license', methods=['POST'])
def set_license():
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    session['license_ok'] = verify_license(request.form['license'])
    return redirect(url_for('dashboard'))

@app.route('/get_system_data')
def get_system_data():
    if 'logged_in' not in session:
        return jsonify({'error': 'Unauthorized'}), 401
    cpu = psutil.cpu_percent(0.1)
    ram = psutil.virtual_memory().percent
    up, down = net_speed()
    xu, _ = xray_users()
    return jsonify({'cpu': cpu, 'ram': ram, 'net': {'upload_mbps': up, 'download_mbps': down}, 'xray': {'users': xu}})

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))
PYEOF

  sed -i "s/key/$SECRET_KEY/" "$APP_DIR/app.py"

  echo "[*] Ø³Ø§Ø®Øª Ø³Ø±ÙˆÛŒØ³ systemd..."
cat > "$SYSTEMD_FILE" <<EOF
[Unit]
Description=Lorna Monitoring Panel
After=network.target

[Service]
User=$(whoami)
WorkingDirectory=$APP_DIR
Environment="FLASK_SECRET_KEY=$SECRET_KEY"
Environment="LORNA_USERNAME=$DEFAULT_USERNAME"
Environment="LORNA_PASSWORD=$DEFAULT_PASSWORD"
Environment="XRAY_PORT=$XRAY_PORT"
Environment="PORT=$APP_PORT"
ExecStart=$VENV_DIR/bin/gunicorn --workers $GUNICORN_WORKERS --bind 0.0.0.0:$APP_PORT app:app
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable "$SERVICE_NAME"
  systemctl start "$SERVICE_NAME"

  echo "âœ… Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ø´Ø¯"
  echo "ğŸ“Œ Ø¢Ø¯Ø±Ø³: http://<IP>:$APP_PORT"
  echo "ğŸ‘¤ $DEFAULT_USERNAME / ğŸ”‘ $DEFAULT_PASSWORD"
  echo "ğŸ“„ Ù„Ø§ÛŒØ³Ù†Ø³: $LICENSE_VALUE"
  echo "â–¶ ØªØ³Øª Ø¯Ø³ØªÛŒ: source $VENV_DIR/bin/activate && python $APP_DIR/app.py"

elif [ "$CHOICE" == "2" ]; then
  echo "[*] Ø­Ø°Ù Ú©Ø§Ù…Ù„..."
  systemctl stop "$SERVICE_NAME" 2>/dev/null || true
  systemctl disable "$SERVICE_NAME" 2>/dev/null || true
  rm -f "$SYSTEMD_FILE"
  systemctl daemon-reload
  pkill -f "gunicorn.*app:app" 2>/dev/null || true
  rm -rf "$APP_DIR" "$LOG_DIR"
  echo "âœ… Ø­Ø°Ù Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"
fi
