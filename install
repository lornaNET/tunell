#!/bin/bash

echo "=== مدیریت پنل مانیتورینگ Netdata روی اوبونتو 22.04 ==="
echo "1) نصب پنل"
echo "2) حذف کامل پنل"
read -p "لطفاً گزینه مورد نظر را وارد کنید (1 یا 2): " CHOICE

if [ "$CHOICE" == "1" ]; then
    read -p "یوزرنیم پنل: " PANEL_USER
    read -sp "پسورد پنل: " PANEL_PASS
    echo
    read -p "پورت پنل (مثلاً 19999): " PANEL_PORT

    # به‌روزرسانی سیستم
    apt update && apt upgrade -y

    # نصب پیش‌نیازها
    apt install -y curl apache2-utils

    # حذف اگر قبلاً نصب بود
    systemctl stop netdata 2>/dev/null
    systemctl disable netdata 2>/dev/null

    # نصب Netdata
    bash <(curl -Ss https://my-netdata.io/kickstart.sh) --dont-wait --disable-telemetry

    # تنظیم پورت دلخواه
    sed -i "s/^bind port = .*/bind port = $PANEL_PORT/" /etc/netdata/netdata.conf

    # ایجاد فایل htpasswd برای احراز هویت ساده (Basic Auth)
    htpasswd -cb /etc/netdata/htpasswd $PANEL_USER $PANEL_PASS

    # فعال کردن احراز هویت Basic در netdata
    cat <<EOF >> /etc/netdata/netdata.conf

[web]
  basic auth login file = /etc/netdata/htpasswd
EOF

    # راه‌اندازی مجدد netdata
    systemctl restart netdata

    echo "✅ نصب کامل شد."
    echo "برای ورود به پنل، آدرس زیر را در مرورگر باز کنید:"
    echo "http://IP-Server:$PANEL_PORT"

elif [ "$CHOICE" == "2" ]; then
    echo "⚠ در حال حذف کامل پنل Netdata..."
    systemctl stop netdata
    apt remove --purge -y netdata
    apt autoremove -y
    rm -f /etc/netdata/htpasswd
    rm -f /etc/netdata/netdata.conf
    echo "✅ پنل و تمام فایل‌ها حذف شدند."
else
    echo "❌ گزینه نامعتبر!"
fi
